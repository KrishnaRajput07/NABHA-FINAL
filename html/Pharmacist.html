<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>NabhaCare ‚Äî Pharmacist Dashboard</title>
  <link rel="stylesheet" href="/css/pharmacist.css">
  <style>
    /* Enhanced profile card styles */
    .profile-detail-card {
      grid-column: span 2;
      position: relative;
      margin-top: 24px;
      padding: 24px;
    }
    
    .profile-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
    }
    
    .profile-header h3 {
      margin: 0;
      color: var(--brand);
      font-size: 1.2rem;
    }
    
    .profile-content {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 24px;
    }
    
    .profile-photo-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }
    
    .profile-photo {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: var(--brand-3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      position: relative;
      overflow: hidden;
      border: 3px solid var(--brand-2);
    }
    
    .profile-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .photo-upload-btn {
      background: var(--brand-3);
      color: var(--brand);
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    
    .photo-upload-btn:hover {
      background: var(--brand-2);
      color: white;
    }
    
    .profile-info-section {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }
    
    .info-group {
      margin-bottom: 20px;
    }
    
    .info-group h4 {
      margin: 0 0 12px;
      color: var(--brand);
      font-size: 1.1rem;
      font-weight: 600;
    }
    
    .info-item {
      display: flex;
      margin-bottom: 12px;
      align-items: flex-start;
    }
    
    .info-label {
      width: 140px;
      color: var(--muted);
      font-size: 0.9rem;
      font-weight: 500;
    }
    
    .info-value {
      flex: 1;
      font-weight: 600;
    }
    
    .edit-icon {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--brand-3);
      color: var(--brand);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 1.1rem;
    }
    
    .edit-icon:hover {
      background: var(--brand-2);
      color: white;
      transform: scale(1.1);
    }
    
    .edit-input {
      width: 100%;
      padding: 8px 12px;
      border: 1.6px solid var(--brand-2);
      border-radius: 8px;
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 500;
    }
    
    .edit-input:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(83, 184, 154, 0.2);
    }
    
    .edit-textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1.6px solid var(--brand-2);
      border-radius: 8px;
      font-family: inherit;
      font-size: 0.9rem;
      min-height: 80px;
      resize: vertical;
    }
    
    .edit-textarea:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(83, 184, 154, 0.2);
    }
    
    .edit-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid var(--brand-3);
    }
    
    .btn-small {
      padding: 8px 16px;
      font-size: 0.9rem;
    }
    
    /* Enhanced responsive adjustments */
    @media (max-width: 820px) {
      .profile-detail-card {
        grid-column: span 1;
        padding: 20px;
      }
      
      .profile-content {
        grid-template-columns: 1fr;
      }
      
      .profile-info-section {
        grid-template-columns: 1fr;
      }
      
      .info-item {
        flex-direction: column;
        gap: 4px;
      }
      
      .info-label {
        width: 100%;
      }
    }
    
    @media (max-width: 600px) {
      .profile-header {
        flex-direction: column;
        gap: 12px;
      }
      
      .profile-photo {
        width: 100px;
        height: 100px;
        font-size: 2.5rem;
      }
      
      .edit-actions {
        flex-direction: column;
        gap: 8px;
      }
      
      .btn-small {
        width: 100%;
      }
    }
    
    /* Enhanced sidebar responsiveness */
    @media (max-width: 820px) {
      .side {
        position: fixed;
        top: 64px;
        left: -280px;
        width: 280px;
        height: calc(100vh - 64px);
        background: linear-gradient(180deg, #ffffffee 0%, #ffffffcc 100%);
        border-right: 1px solid #e7efe9;
        overflow-y: auto;
        z-index: 1000;
        transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      }
      
      .side.open {
        left: 0;
      }
      
      .navlist {
        flex-direction: column;
        padding: 16px;
      }
      
      .navitem {
        padding: 16px 20px;
        border-radius: 12px;
        margin-bottom: 4px;
      }
      
      .mobile-footer {
        display: flex;
        position: fixed;
        bottom: 16px;
        right: 16px;
        z-index: 100;
        gap: 8px;
      }
    }
    
    @media (max-width: 600px) {
      .side {
        width: 100%;
        left: -100%;
      }
      
      .side.open {
        left: 0;
      }
      
      .navitem {
        padding: 14px 16px;
      }
      
      .mobile-footer {
        bottom: 12px;
        right: 12px;
      }
    }
    
    /* Enhanced quick actions section */
    .quick-actions-section {
      margin-top: 24px;
    }
    
    .quick-actions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }
    
    @media (max-width: 820px) {
      .quick-actions-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- NAV -->
  <header class="nav" role="banner">
    <div class="brand">
      <div class="logo" aria-hidden="true">üíä</div>
      <div>
        <div style="font-weight:900">NabhaCare Pharmacy</div>
        <small style="opacity:.9">Medicines & Supplies</small>
      </div>
    </div>
    <div class="nav-actions">
      <span class="chip">Pharmacist: <strong id="phNameTop">Harpreet Singh</strong></span>
      <span class="chip hide-md">Ph ID: <strong id="phIdTop">PH-7781</strong></span>
      <div class="quick">
        <button class="btn ghost" onclick="toast('Open notifications...')">üîî</button>
        <button class="btn" onclick="toggleSide()">‚ò∞</button>
      </div>
    </div>
  </header>
  <!-- SIDEBAR -->
  <aside class="side" role="navigation" aria-label="Sidebar" id="side">
    <h3 class="hide-md">Pharmacy</h3>
    <nav class="navlist" id="sidebar">
      <a class="navitem active" data-tab="profile">üë§ <span class="hide-md">Profile</span></a>
      <a class="navitem" data-tab="stock">üì¶ <span class="hide-md">Stock Management</span></a>
      <a class="navitem" data-tab="expiry">‚ö†Ô∏è <span class="hide-md">Expiry Alerts</span></a>
      <a class="navitem" data-tab="purchase">üõí <span class="hide-md">Purchase Requests</span></a>
      <a class="navitem" data-tab="research">üìö <span class="hide-md">Research Library</span></a>
      <a class="navitem" data-tab="prescriptions">üîç <span class="hide-md">Prescription Lookup</span></a>
      <div style="height:1px"></div>
      <a class="navitem" data-tab="settings">‚öôÔ∏è <span class="hide-md">Settings</span></a>
    </nav>
  </aside>
  <!-- MAIN -->
  <main class="main" role="main">
    <!-- PROFILE -->
    <section id="profile" class="section">
      <h2 class="title">Pharmacist Profile</h2>
      
      <!-- Quick Stats Cards -->
      <div class="grid grid-2">
        <div class="card">
          <div style="display:flex;gap:12px;align-items:center">
            <div class="avatar">HS</div>
            <div>
              <div style="font-weight:800;font-size:1.05rem" id="phName">Harpreet Singh</div>
              <div class="muted">Head Pharmacist ‚Äî Nabha</div>
            </div>
            <div class="right badge ok">ID: <span id="phId">PH-7781</span></div>
          </div>
          <div class="sep"></div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <div class="card small" style="min-width:140px">
              <div class="muted">In-stock SKUs</div>
              <div style="font-weight:800;font-size:1.1rem">342</div>
            </div>
            <div class="card small" style="min-width:140px">
              <div class="muted">Pending Orders</div>
              <div style="font-weight:800;font-size:1.1rem">6</div>
            </div>
            <div class="card small" style="min-width:140px">
              <div class="muted">Low-stock</div>
              <div style="font-weight:800;font-size:1.1rem;color:var(--warn)">12</div>
            </div>
            <div class="card small" style="min-width:140px">
              <div class="muted">Expiring Soon</div>
              <div style="font-weight:800;font-size:1.1rem;color:var(--danger)" id="expiringCount">5</div>
            </div>
          </div>
        </div>
        
        <!-- Quick Actions Card -->
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div>
              <div style="font-weight:800">Quick Actions</div>
              <div class="muted">Fast pharmacy operations</div>
            </div>
          </div>
          <div class="quick-actions-grid">
            <button class="btn" onclick="openAddBatch()">‚ûï Add Batch</button>
            <button class="btn line" onclick="openPurchaseForm()">üõí New Purchase</button>
            <button class="btn line" onclick="toast('Syncing with suppliers‚Ä¶')">‚ü≥ Sync</button>
          </div>
        </div>
      </div>
      
      <!-- Detailed Profile Card -->
      <div class="card profile-detail-card">
        <div class="edit-icon" onclick="toggleProfileEdit()">‚úèÔ∏è</div>
        <div class="profile-header">
          <h3>Detailed Profile Information</h3>
        </div>
        <div class="profile-content">
          <div class="profile-photo-section">
            <div class="profile-photo" id="profilePhoto">
              <span>üíä</span>
            </div>
            <input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="previewProfilePhoto(event)">
            <button class="photo-upload-btn" onclick="document.getElementById('photoInput').click()">Change Photo</button>
          </div>
          <div class="profile-info-section">
            <div class="info-group">
              <h4>Personal Information</h4>
              <div class="info-item">
                <div class="info-label">Full Name:</div>
                <div class="info-value" id="profileFullName">Harpreet Singh</div>
              </div>
              <div class="info-item">
                <div class="info-label">Email:</div>
                <div class="info-value" id="profileEmail">harpreet.singh@nabhacare.in</div>
              </div>
              <div class="info-item">
                <div class="info-label">Phone:</div>
                <div class="info-value" id="profilePhone">+91 98765 43210</div>
              </div>
              <div class="info-item">
                <div class="info-label">Date of Birth:</div>
                <div class="info-value" id="profileDOB">15/03/1985</div>
              </div>
              <div class="info-item">
                <div class="info-label">Gender:</div>
                <div class="info-value" id="profileGender">Male</div>
              </div>
            </div>
            
            <div class="info-group">
              <h4>Professional Information</h4>
              <div class="info-item">
                <div class="info-label">License Number:</div>
                <div class="info-value" id="profileLicense">PUN-PH-2023-7781</div>
              </div>
              <div class="info-item">
                <div class="info-label">Qualification:</div>
                <div class="info-value" id="profileQualification">B.Pharm, M.Pharm</div>
              </div>
              <div class="info-item">
                <div class="info-label">Experience:</div>
                <div class="info-value" id="profileExperience">12 years</div>
              </div>
              <div class="info-item">
                <div class="info-label">Specialization:</div>
                <div class="info-value" id="profileSpecialization">Clinical Pharmacy</div>
              </div>
            </div>
            
            <div class="info-group">
              <h4>Pharmacy Information</h4>
              <div class="info-item">
                <div class="info-label">Pharmacy Name:</div>
                <div class="info-value" id="profilePharmacyName">NabhaCare Pharmacy</div>
              </div>
              <div class="info-item">
                <div class="info-label">Address:</div>
                <div class="info-value" id="profileAddress">Nabha Main Road, Nabha, Punjab - 147201</div>
              </div>
              <div class="info-item">
                <div class="info-label">Contact Email:</div>
                <div class="info-value" id="profilePharmacyEmail">pharmacy@nabhacare.in</div>
              </div>
              <div class="info-item">
                <div class="info-label">Contact Phone:</div>
                <div class="info-value" id="profilePharmacyPhone">+91 98765 43211</div>
              </div>
            </div>
            
            <div class="info-group">
              <h4>Bio</h4>
              <div class="info-item">
                <div class="info-value" id="profileBio">Experienced pharmacist with expertise in clinical pharmacy and medication management. Committed to providing quality healthcare services and patient counseling.</div>
              </div>
            </div>
          </div>
        </div>
        <div class="edit-actions" id="profileEditActions" style="display: none;">
          <button class="btn line btn-small" onclick="cancelProfileEdit()">Cancel</button>
          <button class="btn btn-small" onclick="saveProfileChanges()">Save Changes</button>
        </div>
      </div>
    </section>
    <!-- STOCK MANAGEMENT -->
    <section id="stock" class="section hidden">
      <h2 class="title">Stock Management</h2>
      <div class="card stock-toolbar" style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <input id="stockSearch" class="input" placeholder="Search medicine, salt, or batch">
        <button class="pill active" data-stock="all" onclick="filterStock(this)">All</button>
        <button class="pill" data-stock="low" onclick="filterStock(this)">Low</button>
        <button class="pill" data-stock="out" onclick="filterStock(this)">Out</button>
        <button class="pill" data-stock="expiring" onclick="filterStock(this)">Expiring Soon</button>
        <div class="right" style="margin-left:auto;display:flex;gap:8px">
          <button class="btn" onclick="exportStock()">‚¨áÔ∏è Export</button>
          <button class="btn line" onclick="openAddBatch()">‚ûï Add Batch</button>
        </div>
      </div>
      <div class="card" style="padding:0;overflow:hidden">
        <table>
          <thead>
            <tr>
              <th>Medicine</th>
              <th>Salt</th>
              <th>Batch No.</th>
              <th>Qty</th>
              <th>Expiry</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="stockBody"></tbody>
        </table>
      </div>
    </section>
    <!-- EXPIRY ALERTS SECTION -->
    <section id="expiry" class="section hidden">
      <h2 class="title">Expiry Alerts</h2>
      <div class="card">
        <div id="expiryAlerts">
          <!-- Expiry alerts will be populated here -->
        </div>
      </div>
    </section>
    <!-- PURCHASE REQUESTS -->
    <section id="purchase" class="section hidden">
      <h2 class="title">Purchase Requests</h2>
      
      <div class="card" style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:16px">
        <input id="purchaseSearch" class="input" placeholder="Search requests...">
        <button class="btn line" onclick="openPurchaseForm()">‚ûï New Request</button>
      </div>
      <div id="purchaseList" class="grid" style="grid-template-columns:repeat(auto-fit,minmax(320px,1fr));">
        <!-- dynamic requests -->
      </div>
    </section>
    <!-- RESEARCH LIBRARY -->
    <section id="research" class="section hidden">
      <h2 class="title">Research Library</h2>
      <div class="card" style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:16px">
        <input id="researchSearch" class="input" placeholder="Search research & docs">
        <button class="btn line" onclick="toast('Fetching latest papers‚Ä¶')">üîé Search</button>
        <button class="btn line" onclick="toast('Opening research upload‚Ä¶')">üì§ Upload</button>
      </div>
      <div id="researchList" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(260px,1fr));">
        <!-- research cards -->
      </div>
    </section>
    <!-- PRESCRIPTIONS LOOKUP -->
    <section id="prescriptions" class="section hidden">
      <h2 class="title">Prescription Lookup</h2>
      <div class="card" style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:16px">
        <input id="prescSearch" class="input" placeholder="Enter Patient ID or Prescription ID (e.g. PA-001, RX-2025-01)">
        <button class="btn" onclick="searchPrescription()">Search</button>
        <button class="btn line" onclick="demoAIPresc()">Demo AI Presc</button>
      </div>
      <div id="prescResult" style="margin-top:12px"></div>
    </section>
    <!-- SETTINGS -->
    <section id="settings" class="section hidden">
      <h2 class="title">Settings</h2>
      
      <div class="grid grid-2">
        <div class="card">
          <div style="font-weight:800;margin-bottom:12px">Account Preferences</div>
          <div style="display:flex;flex-direction:column;gap:10px">
            <label style="display:flex;gap:8px;align-items:center">
              <input type="checkbox" id="autoSync"> Auto-sync with suppliers
            </label>
            <label style="display:flex;gap:8px;align-items:center">
              <input type="checkbox" id="lowStockAlerts" checked> Low stock alerts
            </label>
            <label style="display:flex;gap:8px;align-items:center">
              <input type="checkbox" id="expiryAlerts" checked> Expiry alerts
            </label>
          </div>
        </div>
        
        <div class="card">
          <div style="font-weight:800;margin-bottom:12px">Notification Settings</div>
          <div style="display:flex;flex-direction:column;gap:10px">
            <label style="display:flex;gap:8px;align-items:center">
              <input type="checkbox" checked> Email notifications
            </label>
            <label style="display:flex;gap:8px;align-items:center">
              <input type="checkbox" checked> Push notifications
            </label>
            <label style="display:flex;gap:8px;align-items:center">
              <input type="checkbox"> SMS alerts
            </label>
          </div>
        </div>
        
        <div class="card" style="grid-column: span 2">
          <div style="font-weight:800;margin-bottom:12px">Pharmacy Information</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <label style="display:block;margin-bottom:4px;font-weight:600">Pharmacy Name</label>
              <input type="text" class="input" value="NabhaCare Pharmacy">
            </div>
            <div>
              <label style="display:block;margin-bottom:4px;font-weight:600">License Number</label>
              <input type="text" class="input" value="PUN-PH-2023-7781">
            </div>
            <div>
              <label style="display:block;margin-bottom:4px;font-weight:600">Contact Email</label>
              <input type="email" class="input" value="pharmacy@nabhacare.in">
            </div>
            <div>
              <label style="display:block;margin-bottom:4px;font-weight:600">Phone Number</label>
              <input type="tel" class="input" value="+91 98765 43210">
            </div>
            <div style="grid-column: span 2">
              <label style="display:block;margin-bottom:4px;font-weight:600">Address</label>
              <textarea class="textarea" rows="2">Nabha Main Road, Nabha, Punjab - 147201</textarea>
            </div>
          </div>
          <div style="display:flex;justify-content:flex-end;margin-top:12px">
            <button class="btn" onclick="toast('Settings saved successfully')">Save Changes</button>
          </div>
        </div>
      </div>
    </section>
  </main>
  <!-- DRAWER: Add/Update Batch -->
  <aside class="drawer" id="batchDrawer" aria-hidden="true">
    <div class="drawer-head">
      <div style="display:flex;gap:12px;align-items:center">
        <div style="font-weight:900">Add / Update Medicine Batch</div>
      </div>
      <div>
        <button class="btn line" onclick="closeBatchDrawer()">Close</button>
      </div>
    </div>
    <div class="drawer-body">
      <form id="batchForm" onsubmit="return handleBatchSubmit(event)">
        <div class="card small">
          <label>Medicine Name *</label>
          <input id="batchName" class="input" placeholder="e.g. Paracetamol 500mg" required>
          <label style="margin-top:8px">Salt / Composition *</label>
          <input id="batchSalt" class="input" placeholder="e.g. Acetaminophen" required>
          <label style="margin-top:8px">Batch Number *</label>
          <input id="batchNumber" class="input" placeholder="e.g. BATCH001" required>
          <div class="batch-info">Unique identifier for this batch</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <div style="flex:1">
              <label>Quantity *</label>
              <input id="batchQty" type="number" class="input" min="0" required>
            </div>
            <div style="flex:1">
              <label>Expiry Date *</label>
              <input id="batchExpiry" type="date" class="input" required>
            </div>
          </div>
          <div class="warning" id="expiryWarning"></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button type="submit" class="btn">Save Batch</button>
            <button type="button" class="btn line" onclick="closeBatchDrawer()">Cancel</button>
          </div>
        </div>
      </form>
      <div class="card small">
        <div style="font-weight:800">Recent Adds</div>
        <div id="recentAdds" class="muted" style="margin-top:8px">‚Äî</div>
      </div>
    </div>
  </aside>
  <!-- MODAL: Purchase Request Form -->
  <div class="modal-back" id="purchaseModal">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
        <div style="font-weight:900">New Purchase Request</div>
        <button class="btn line" onclick="closePurchaseModal()">Close</button>
      </div>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <label style="display:block;margin-bottom:4px;font-weight:600">Medicine Name</label>
          <input id="purchaseName" class="input" placeholder="e.g. Amoxicillin 500mg">
        </div>
        <div>
          <label style="display:block;margin-bottom:4px;font-weight:600">Quantity</label>
          <input id="purchaseQty" type="number" class="input" placeholder="e.g. 50">
        </div>
        <div>
          <label style="display:block;margin-bottom:4px;font-weight:600">Priority</label>
          <select id="purchasePriority" class="select">
            <option value="normal">Normal</option>
            <option value="high">High Priority</option>
            <option value="urgent">Urgent</option>
          </select>
        </div>
        <div>
          <label style="display:block;margin-bottom:4px;font-weight:600">Requested By</label>
          <input id="purchaseRequester" class="input" placeholder="Your name or department">
        </div>
        <div style="grid-column: span 2">
          <label style="display:block;margin-bottom:4px;font-weight:600">Notes</label>
          <textarea id="purchaseNotes" class="textarea" rows="3" placeholder="Additional information..."></textarea>
        </div>
      </div>
      
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:16px">
        <button class="btn line" onclick="closePurchaseModal()">Cancel</button>
        <button class="btn" onclick="submitPurchaseRequest()">Submit Request</button>
      </div>
    </div>
  </div>
  <!-- MODAL: Research Preview -->
  <div class="modal-back" id="researchModal">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div style="font-weight:900" id="researchTitle">Research Title</div>
        <button class="btn line" onclick="closeResearchModal()">Close</button>
      </div>
      <div id="researchBody" style="max-height:60vh;overflow:auto" class="muted">Abstract / preview...</div>
    </div>
  </div>
  <!-- MODAL: Prescription AI / Fulfill -->
  <div class="modal-back" id="prescModal">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div style="font-weight:900" id="prescTitle">Prescription</div>
        <button class="btn line" onclick="closePrescModal()">Close</button>
      </div>
      <div id="prescBody">
        <!-- AI output will go here -->
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn" onclick="fulfillPrescription()">‚úîÔ∏è Fulfill & Dispense</button>
        <button class="btn line" onclick="toast('Sent to ordering system')">Push to Purchase</button>
      </div>
    </div>
  </div>
  <!-- mobile quick -->
  <div class="mobile-footer" id="mobileFooter">
    <button class="btn" onclick="openTab('prescriptions')">Prescriptions</button>
    <button class="btn" onclick="openTab('stock')">Stock</button>
    <button class="btn" onclick="openTab('purchase')">Requests</button>
  </div>
  
  <script>
    // Profile editing functionality
    let isEditingProfile = false;
    
    function toggleProfileEdit() {
      isEditingProfile = !isEditingProfile;
      
      if (isEditingProfile) {
        enableProfileEdit();
      } else {
        cancelProfileEdit();
      }
    }
    
    function enableProfileEdit() {
      // Show edit actions
      document.getElementById('profileEditActions').style.display = 'flex';
      
      // Replace info values with input fields
      const editableFields = [
        'profileFullName', 'profileEmail', 'profilePhone', 'profileDOB', 'profileGender',
        'profileLicense', 'profileQualification', 'profileExperience', 'profileSpecialization',
        'profilePharmacyName', 'profileAddress', 'profilePharmacyEmail', 'profilePharmacyPhone'
      ];
      
      editableFields.forEach(fieldId => {
        const element = document.getElementById(fieldId);
        const currentValue = element.textContent;
        
        if (fieldId === 'profileDOB') {
          element.innerHTML = `<input type="date" class="edit-input" value="${formatDateForInput(currentValue)}">`;
        } else if (fieldId === 'profileGender') {
          element.innerHTML = `
            <select class="edit-input">
              <option value="Male" ${currentValue === 'Male' ? 'selected' : ''}>Male</option>
              <option value="Female" ${currentValue === 'Female' ? 'selected' : ''}>Female</option>
              <option value="Other" ${currentValue === 'Other' ? 'selected' : ''}>Other</option>
            </select>
          `;
        } else {
          element.innerHTML = `<input type="text" class="edit-input" value="${currentValue}">`;
        }
      });
      
      // Handle bio field
      const bioElement = document.getElementById('profileBio');
      const bioValue = bioElement.textContent;
      bioElement.innerHTML = `<textarea class="edit-textarea">${bioValue}</textarea>`;
    }
    
    function cancelProfileEdit() {
      // Hide edit actions
      document.getElementById('profileEditActions').style.display = 'none';
      
      // Restore original values
      const originalValues = {
        'profileFullName': 'Harpreet Singh',
        'profileEmail': 'harpreet.singh@nabhacare.in',
        'profilePhone': '+91 98765 43210',
        'profileDOB': '15/03/1985',
        'profileGender': 'Male',
        'profileLicense': 'PUN-PH-2023-7781',
        'profileQualification': 'B.Pharm, M.Pharm',
        'profileExperience': '12 years',
        'profileSpecialization': 'Clinical Pharmacy',
        'profilePharmacyName': 'NabhaCare Pharmacy',
        'profileAddress': 'Nabha Main Road, Nabha, Punjab - 147201',
        'profilePharmacyEmail': 'pharmacy@nabhacare.in',
        'profilePharmacyPhone': '+91 98765 43211',
        'profileBio': 'Experienced pharmacist with expertise in clinical pharmacy and medication management. Committed to providing quality healthcare services and patient counseling.'
      };
      
      Object.keys(originalValues).forEach(fieldId => {
        document.getElementById(fieldId).textContent = originalValues[fieldId];
      });
      
      isEditingProfile = false;
    }
    
    function saveProfileChanges() {
      // Get all input values
      const updatedValues = {};
      
      const editableFields = [
        'profileFullName', 'profileEmail', 'profilePhone', 'profileDOB', 'profileGender',
        'profileLicense', 'profileQualification', 'profileExperience', 'profileSpecialization',
        'profilePharmacyName', 'profileAddress', 'profilePharmacyEmail', 'profilePharmacyPhone'
      ];
      
      editableFields.forEach(fieldId => {
        const element = document.getElementById(fieldId);
        const input = element.querySelector('input, select, textarea');
        if (input) {
          updatedValues[fieldId] = input.value;
        }
      });
      
      // Update the display with new values
      Object.keys(updatedValues).forEach(fieldId => {
        const element = document.getElementById(fieldId);
        element.textContent = updatedValues[fieldId];
      });
      
      // Hide edit actions
      document.getElementById('profileEditActions').style.display = 'none';
      
      isEditingProfile = false;
      
      // Show success message
      toast('Profile updated successfully');
    }
    
    function formatDateForInput(dateString) {
      // Convert from DD/MM/YYYY to YYYY-MM-DD for input field
      const parts = dateString.split('/');
      if (parts.length === 3) {
        return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
      }
      return dateString;
    }
    
    function previewProfilePhoto(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('profilePhoto').innerHTML = `<img src="${e.target.result}" alt="Profile Photo">`;
        };
        reader.readAsDataURL(file);
      }
    }
    
    // Enhanced sidebar toggle function
    function toggleSide() {
      const side = document.getElementById('side');
      const isOpen = side.classList.contains('open');
      
      if (window.innerWidth <= 820) {
        // On small screens, toggle the overlay drawer
        if (isOpen) {
          side.classList.remove('open');
        } else {
          side.classList.add('open');
        }
      } else {
        // On larger screens, toggle the sidebar normally
        side.classList.toggle('open');
      }
    }
    
    function closeSide() { 
      const side = document.getElementById('side');
      side.classList.remove('open');
    }
    
    // Rest of the existing JavaScript code remains unchanged
    const stockData = [
      {id: 1, name:"Paracetamol 500mg", salt:"Acetaminophen", batch:"BATCH001", qty:10, expiry:"2025-09-30", status:"low"},
      {id: 2, name:"Paracetamol 500mg", salt:"Acetaminophen", batch:"BATCH002", qty:25, expiry:"2026-02-15", status:"ok"},
      {id: 3, name:"Paracetamol 500mg", salt:"Acetaminophen", batch:"BATCH003", qty:0, expiry:"2025-07-01", status:"out"},
      {id: 4, name:"Amoxicillin 500mg", salt:"Amoxicillin", batch:"BATCH045", qty:15, expiry:"2024-12-15", status:"ok"},
      {id: 5, name:"Ibuprofen 200mg", salt:"Ibuprofen", batch:"BATCH128", qty:5, expiry:"2025-03-20", status:"low"},
      {id: 6, name:"Cetirizine 10mg", salt:"Cetirizine", batch:"BATCH201", qty:86, expiry:"2026-01-10", status:"ok"},
      {id: 7, name:"Omeprazole 20mg", salt:"Omeprazole", batch:"BATCH078", qty:15, expiry:"2025-03-05", status:"low"},
      {id: 8, name:"Atorvastatin 10mg", salt:"Atorvastatin", batch:"BATCH332", qty:42, expiry:"2025-08-22", status:"ok"},
      {id: 9, name:"Metformin 500mg", salt:"Metformin", batch:"BATCH115", qty:28, expiry:"2025-05-18", status:"low"},
      {id: 10, name:"Losartan 50mg", salt:"Losartan", batch:"BATCH299", qty:64, expiry:"2026-03-14", status:"ok"},
    ];
    const purchaseRequests = [
      {id:"PR-001", requester:"Clinic - Dr. Aman", items:[{name:"Amoxicillin 500mg", qty:20}], note:"Urgent", status:"pending", date:"2023-05-15"},
      {id:"PR-002", requester:"Patient - Kiran Bala", items:[{name:"Ibuprofen 200mg", qty:10}], note:"Home delivery", status:"pending", date:"2023-05-14"},
      {id:"PR-003", requester:"Ward 4 - Nurse Station", items:[{name:"Paracetamol 500mg", qty:50}, {name:"Cetirizine 10mg", qty:30}], note:"Monthly restock", status:"approved", date:"2023-05-10"},
    ];
    const researchDocs = [
      {id:"R-001", title:"Comparative efficacy of Paracetamol", body:"Abstract: This study compares the efficacy of paracetamol across different patient demographics. Results show consistent pain relief in 89% of cases with minimal side effects."},
      {id:"R-002", title:"Amoxicillin ‚Äì dosage guidelines", body:"Abstract: Updated guidelines for antibiotic stewardship recommend reduced duration of amoxicillin courses for uncomplicated infections to combat antimicrobial resistance."},
      {id:"R-003", title:"Drug interactions with Omeprazole", body:"Abstract: Review of PPI interactions with common cardiovascular and psychiatric medications. Notable interactions found with clopidogrel and diazepam requiring dosage adjustments."},
      {id:"R-004", title:"Storage stability of insulin analogs", body:"Abstract: Study on the stability of various insulin formulations under different storage conditions. Recommendations provided for optimal pharmacy storage practices."},
    ];
    /* Sidebar tabs */
    const navitems = document.querySelectorAll('.navitem');
    const sections = document.querySelectorAll('.section');
    navitems.forEach(n => n.addEventListener('click', (e)=>{
      e.preventDefault();
      navitems.forEach(x=>x.classList.remove('active'));
      n.classList.add('active');
      openTab(n.dataset.tab);
      if(window.innerWidth <= 820) closeSide();
    }));
    function openTab(id){
      sections.forEach(s=>s.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      if(id === 'stock') renderStock();
      if(id === 'expiry') checkExpiryAlerts();
      if(id === 'purchase') renderPurchase();
      if(id === 'research') renderResearch();
      if(id === 'prescriptions') { document.getElementById('prescResult').innerHTML=''; }
    }
    // initial
    document.addEventListener('DOMContentLoaded', ()=>{ 
      openTab('profile'); 
      renderStock(); 
      renderPurchase(); 
      renderResearch(); 
      checkExpiryAlerts();
      updateExpiringCount();
    });
    /* STOCK with batch-wise tracking */
    const stockBody = document.getElementById('stockBody');
    function renderStock(){
      const q = (document.getElementById('stockSearch') || {}).value || '';
      const view = document.querySelector('.pill.active')?.dataset?.stock || 'all';
      
      const list = stockData.filter(m => {
        const okQ = !q || 
          m.name.toLowerCase().includes(q.toLowerCase()) || 
          m.salt.toLowerCase().includes(q.toLowerCase()) ||
          m.batch.toLowerCase().includes(q.toLowerCase());
        
        // Determine status based on quantity and expiry
        const today = new Date();
        const expiryDate = new Date(m.expiry);
        let status = m.status;
        
        // Check if expired
        if (expiryDate < today) {
          status = 'expired';
        }
        
        const okV = view === 'all' || 
                   (view === 'low' && status === 'low') ||
                   (view === 'out' && status === 'out') ||
                   (view === 'expiring' && isExpiringSoon(expiryDate));
        
        return okQ && okV;
      });
      
      stockBody.innerHTML = list.map(m => {
        const today = new Date();
        const expiryDate = new Date(m.expiry);
        let status = m.status;
        let statusClass = status;
        
        // Check if expired
        if (expiryDate < today) {
          status = 'expired';
          statusClass = 'expired';
        }
        
        const st = status === 'ok' ? '<span class="badge ok">Available</span>' :
                 status === 'low' ? '<span class="badge warn">Low</span>' :
                 status === 'out' ? '<span class="badge danger">Out</span>' :
                 '<span class="badge expired">Expired</span>';
                 
        const qtyCls = status === 'ok' ? 'qty' : status === 'low' ? 'low' : 'out';
        
        return `<tr>
          <td>${m.name}</td>
          <td class="muted">${m.salt}</td>
          <td>${m.batch}</td>
          <td class="${qtyCls}">${m.qty}</td>
          <td>${formatDate(m.expiry)}</td>
          <td>${st}</td>
          <td>
            <button class="btn line" onclick="editBatch(${m.id})">Edit</button>
            <button class="btn line" onclick="deleteBatch(${m.id})" style="color: #c5221f;">Delete</button>
          </td>
        </tr>`;
      }).join('') || `<tr><td colspan="7" class="muted" style="text-align:center">No items found.</td></tr>`;
    }
    document.getElementById('stockSearch')?.addEventListener('input', renderStock);
    function filterStock(btn){
      document.querySelectorAll('.pill').forEach(p=>p.classList.remove('active'));
      btn.classList.add('active');
      renderStock();
    }
    /* Add batch drawer */
    const batchDrawer = document.getElementById('batchDrawer');
    function openAddBatch(){
      batchDrawer.classList.add('open');
      batchDrawer.setAttribute('aria-hidden','false');
      document.getElementById('batchForm').reset();
      document.getElementById('expiryWarning').textContent = '';
    }
    
    function closeBatchDrawer(){
      batchDrawer.classList.remove('open');
      batchDrawer.setAttribute('aria-hidden','true');
    }
    
    // Validate expiry date
    document.getElementById('batchExpiry')?.addEventListener('change', function() {
      const expiryDate = new Date(this.value);
      const today = new Date();
      const warningEl = document.getElementById('expiryWarning');
      
      if (this.value && expiryDate < today) {
        warningEl.textContent = 'Warning: This expiry date has already passed!';
      } else {
        warningEl.textContent = '';
      }
    });
    
    function handleBatchSubmit(event) {
      event.preventDefault();
      
      const name = document.getElementById('batchName').value.trim();
      const salt = document.getElementById('batchSalt').value.trim();
      const batch = document.getElementById('batchNumber').value.trim();
      const quantity = parseInt(document.getElementById('batchQty').value);
      const expiry = document.getElementById('batchExpiry').value;
      
      if (!name || !salt || !batch || isNaN(quantity) || quantity < 0 || !expiry) {
        toast('Please fill all required fields correctly');
        return;
      }
      
      // Determine status based on quantity
      let status = 'ok';
      if (quantity === 0) {
        status = 'out';
      } else if (quantity < 10) {
        status = 'low';
      }
      
      // Check if batch already exists
      const existingIndex = stockData.findIndex(item => item.batch === batch);
      
      if (existingIndex !== -1) {
        // Update existing batch
        stockData[existingIndex] = {
          ...stockData[existingIndex],
          name,
          salt,
          quantity,
          expiry,
          status
        };
        document.getElementById('recentAdds').textContent = `${name} (${batch}) updated`;
      } else {
        // Add new batch
        const newId = Math.max(...stockData.map(item => item.id), 0) + 1;
        stockData.unshift({
          id: newId,
          name,
          salt,
          batch,
          qty: quantity,
          expiry,
          status
        });
        document.getElementById('recentAdds').textContent = `${name} (${batch}) x${quantity} added`;
      }
      
      closeBatchDrawer();
      renderStock();
      checkExpiryAlerts();
      updateExpiringCount();
      toast('Batch saved successfully');
    }
    
    function editBatch(id) {
      const item = stockData.find(item => item.id === id);
      if (item) {
        document.getElementById('batchName').value = item.name;
        document.getElementById('batchSalt').value = item.salt;
        document.getElementById('batchNumber').value = item.batch;
        document.getElementById('batchQty').value = item.qty;
        document.getElementById('batchExpiry').value = item.expiry;
        
        batchDrawer.classList.add('open');
        batchDrawer.setAttribute('aria-hidden','false');
      }
    }
    
    function deleteBatch(id) {
      if (confirm('Are you sure you want to delete this batch?')) {
        const index = stockData.findIndex(item => item.id === id);
        if (index !== -1) {
          stockData.splice(index, 1);
          renderStock();
          checkExpiryAlerts();
          updateExpiringCount();
          toast('Batch deleted successfully');
        }
      }
    }
    
    function isExpiringSoon(expiryDate) {
      const today = new Date();
      const ninetyDaysFromNow = new Date();
      ninetyDaysFromNow.setDate(today.getDate() + 90);
      return expiryDate > today && expiryDate <= ninetyDaysFromNow;
    }
    
    function formatDate(dateString) {
      const options = { year: 'numeric', month: 'short', day: 'numeric' };
      return new Date(dateString).toLocaleDateString(undefined, options);
    }
    
    function updateExpiringCount() {
      const today = new Date();
      const ninetyDaysFromNow = new Date();
      ninetyDaysFromNow.setDate(today.getDate() + 90);
      
      const expiringCount = stockData.filter(item => {
        const expiryDate = new Date(item.expiry);
        return expiryDate > today && expiryDate <= ninetyDaysFromNow;
      }).length;
      
      document.getElementById('expiringCount').textContent = expiringCount;
    }
    
    /* Check for expiry alerts */
    function checkExpiryAlerts() {
      const today = new Date();
      const thirtyDaysFromNow = new Date();
      thirtyDaysFromNow.setDate(today.getDate() + 30);
      
      const expiringSoon = stockData.filter(item => {
        const expiryDate = new Date(item.expiry);
        return expiryDate > today && expiryDate <= thirtyDaysFromNow;
      });
      
      const expired = stockData.filter(item => {
        const expiryDate = new Date(item.expiry);
        return expiryDate < today;
      });
      
      const alertsContainer = document.getElementById('expiryAlerts');
      alertsContainer.innerHTML = '';
      
      if (expiringSoon.length === 0 && expired.length === 0) {
        alertsContainer.innerHTML = '<p>No expiry alerts at this time.</p>';
        return;
      }
      
      if (expired.length > 0) {
        const expiredHeader = document.createElement('h3');
        expiredHeader.textContent = 'Expired Batches';
        expiredHeader.style.color = '#c5221f';
        alertsContainer.appendChild(expiredHeader);
        
        expired.forEach(item => {
          const alert = document.createElement('div');
          alert.className = 'expiry-alert expired';
          alert.innerHTML = `
            <p><strong>${item.name} (Batch: ${item.batch})</strong> expired on ${formatDate(item.expiry)}</p>
            <p class="warning">Please remove from stock immediately.</p>
          `;
          alertsContainer.appendChild(alert);
        });
      }
      
      if (expiringSoon.length > 0) {
        const expiringHeader = document.createElement('h3');
        expiringHeader.textContent = 'Batches Expiring Soon (within 30 days)';
        expiringHeader.style.color = '#b06000';
        alertsContainer.appendChild(expiringHeader);
        
        expiringSoon.forEach(item => {
          const alert = document.createElement('div');
          alert.className = 'expiry-alert';
          alert.innerHTML = `
            <p><strong>${item.name} (Batch: ${item.batch})</strong> expires on ${formatDate(item.expiry)}</p>
            <p>Current quantity: ${item.qty}</p>
          `;
          alertsContainer.appendChild(alert);
        });
      }
    }
    
    function exportStock() {
      // In a real application, this would generate a CSV file
      toast('Exporting stock data to CSV...');
      console.log('Stock data exported:', stockData);
    }
    /* PURCHASE requests */
    function renderPurchase(){
      const el = document.getElementById('purchaseList');
      const searchTerm = (document.getElementById('purchaseSearch') || {}).value || '';
      
      const filteredRequests = purchaseRequests.filter(r => 
        !searchTerm || 
        r.requester.toLowerCase().includes(searchTerm.toLowerCase()) || 
        r.id.toLowerCase().includes(searchTerm.toLowerCase()) ||
        r.items.some(i => i.name.toLowerCase().includes(searchTerm.toLowerCase()))
      );
      
      el.innerHTML = filteredRequests.map(r => {
        const items = r.items.map(i => `${i.name} √ó${i.qty}`).join(', ');
        const statusClass = r.status === 'approved' ? 'ok' : r.status === 'rejected' ? 'danger' : 'warn';
        const statusText = r.status === 'approved' ? 'Approved' : r.status === 'rejected' ? 'Rejected' : 'Pending';
        
        return `<div class="card request fade-in">
          <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
            <div style="font-weight:800">${r.requester}</div>
            <div class="muted">${r.id}</div>
            <div class="badge ${statusClass}">${statusText}</div>
          </div>
          <div class="muted" style="margin-bottom:8px">${items}</div>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="muted">${r.note} ‚Ä¢ ${r.date}</div>
            <div class="actions">
              ${r.status === 'pending' ? `
                <button class="btn" onclick="approveRequest('${r.id}')">Approve</button>
                <button class="btn line" onclick="rejectRequest('${r.id}')">Reject</button>
              ` : ''}
            </div>
          </div>
        </div>`;
      }).join('') || '<div class="card muted">No requests found</div>';
    }
    
    document.getElementById('purchaseSearch')?.addEventListener('input', renderPurchase);
    
    function approveRequest(id){
      const idx = purchaseRequests.findIndex(r=>r.id===id);
      if(idx===-1) return;
      purchaseRequests[idx].status='approved';
      toast('Request approved ‚Äî pushed to supplier');
      renderPurchase();
    }
    
    function rejectRequest(id){
      const idx = purchaseRequests.findIndex(r=>r.id===id);
      if(idx===-1) return;
      purchaseRequests[idx].status='rejected';
      toast('Request rejected');
      renderPurchase();
    }
    
    function openPurchaseForm(){ 
      document.getElementById('purchaseModal').classList.add('show');
    }
    
    function closePurchaseModal() {
      document.getElementById('purchaseModal').classList.remove('show');
    }
    
    function submitPurchaseRequest() {
      const name = document.getElementById('purchaseName').value.trim();
      const qty = document.getElementById('purchaseQty').value;
      const requester = document.getElementById('purchaseRequester').value.trim();
      const notes = document.getElementById('purchaseNotes').value.trim();
      
      if(!name || !qty || !requester) {
        toast('Please fill required fields');
        return;
      }
      
      const newRequest = {
        id: `PR-${String(purchaseRequests.length + 1).padStart(3, '0')}`,
        requester: requester,
        items: [{name: name, qty: parseInt(qty)}],
        note: notes || 'No additional notes',
        status: 'pending',
        date: new Date().toISOString().split('T')[0]
      };
      
      purchaseRequests.unshift(newRequest);
      closePurchaseModal();
      renderPurchase();
      toast('Purchase request submitted');
    }
    /* RESEARCH */
    function renderResearch(){
      const list = researchDocs;
      const searchTerm = (document.getElementById('researchSearch') || {}).value || '';
      
      const filteredDocs = researchDocs.filter(d => 
        !searchTerm || 
        d.title.toLowerCase().includes(searchTerm.toLowerCase()) || 
        d.body.toLowerCase().includes(searchTerm.toLowerCase())
      );
      
      const el = document.getElementById('researchList');
      el.innerHTML = filteredDocs.map(d => `
        <div class="card fade-in">
          <div style="font-weight:800;margin-bottom:8px">${d.title}</div>
          <div class="muted" style="margin-bottom:12px;font-size:0.9rem">${d.body.substring(0, 100)}...</div>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="muted">Document ID: ${d.id}</div>
            <button class="btn line" onclick="previewResearch('${d.id}')">Read More</button>
          </div>
        </div>`).join('') || '<div class="card muted">No research documents found</div>';
    }
    
    document.getElementById('researchSearch')?.addEventListener('input', renderResearch);
    
    function previewResearch(id){
      const doc = researchDocs.find(d=>d.id===id);
      if(!doc) return;
      document.getElementById('researchTitle').textContent = doc.title;
      document.getElementById('researchBody').textContent = doc.body;
      document.getElementById('researchModal').classList.add('show');
    }
    
    function closeResearchModal(){ 
      document.getElementById('researchModal').classList.remove('show'); 
    }
    /* PRESCRIPTION lookup + AI example */
    function searchPrescription(){
      const q = document.getElementById('prescSearch').value.trim();
      if(!q){ toast('Enter an ID to search'); return; }
      // demo: if q matches PA-001 show patient
      if(q.toLowerCase().includes('pa-001') || q.toLowerCase().includes('rx-demo')){
        renderPrescModal({
          pid:'PA-001',
          patient:'Gurpreet Kaur',
          age:32,
          meds:[
            {name:'Paracetamol 500mg', dose:'1 tab', freq:'8 hourly', days:3},
            {name:'Cetirizine 10mg', dose:'1 tab', freq:'once daily', days:5}
          ],
          notes:'Take with food. Return if fever persists.'
        });
      } else {
        document.getElementById('prescResult').innerHTML = `
          <div class="card muted" style="text-align:center">
            No prescription found for "${q}". Try searching for "PA-001" or "RX-DEMO" for a demo.
          </div>
        `;
      }
    }
    function demoAIPresc(){
      // Demo of AI-generated prescription card
      renderPrescModal({
        pid:'AI-RX-2025-07',
        patient:'Sample Patient',
        age:45,
        meds:[
          {name:'Amoxicillin 500mg', dose:'1 cap', freq:'8 hourly', days:5},
          {name:'Paracetamol 500mg', dose:'1 tab', freq:'6 hourly', days:3}
        ],
        notes:'AI-suggested: check allergy history before dispensing.'
      });
    }
    function renderPrescModal(p){
      document.getElementById('prescTitle').textContent = `Prescription ‚Ä¢ ${p.pid}`;
      const body = document.getElementById('prescBody');
      body.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div><strong>${p.patient}</strong> ‚Ä¢ ${p.age} yrs</div>
          <div class="muted">ID: ${p.pid}</div>
        </div>
        <div style="border-radius:10px;padding:12px;background:#fbfff9">
          ${p.meds.map(m=>`<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #eef6ef">
            <div><strong>${m.name}</strong><div class="muted">${m.dose} ‚Ä¢ ${m.freq}</div></div>
            <div class="muted">${m.days} days</div>
          </div>`).join('')}
        </div>
        <div style="margin-top:12px" class="muted"><strong>Notes:</strong> ${p.notes}</div>
        <div style="margin-top:8px">
          <label style="display:block;margin-bottom:6px">Adjust quantities / mark as ready</label>
          <textarea id="fulfillNotes" class="textarea" rows="3" placeholder="Add packing notes or instructions"></textarea>
        </div>
      `;
      document.getElementById('prescModal').classList.add('show');
    }
    function closePrescModal(){ document.getElementById('prescModal').classList.remove('show') }
    function fulfillPrescription(){
      const notes = document.getElementById('fulfillNotes')?.value || '';
      toast('Prescription fulfilled. ' + (notes ? 'Notes saved.' : ''));
      closePrescModal();
    }
    /* Toast helper */
    function toast(msg){
      const t = document.createElement('div');
      t.textContent = msg;
      Object.assign(t.style,{
        position:'fixed',
        left:'50%',
        transform:'translateX(-50%)',
        bottom:'24px',
        background:'#223729',
        color:'#fff',
        padding:'10px 14px',
        borderRadius:'10px',
        zIndex:9999,
        opacity:0,
        transition:'opacity .18s',
        fontSize: '14px',
        fontWeight: '500'
      });
      document.body.appendChild(t);
      requestAnimationFrame(()=>t.style.opacity='1');
      setTimeout(()=>{ t.style.opacity=0; setTimeout(()=>t.remove(),220) },1700);
    }
    /* Utility: open specific tab (mobile quick) */
    function openTab(id){
      document.querySelectorAll('.navitem').forEach(n=>n.classList.remove('active'));
      document.querySelector(`.navitem[data-tab="${id}"]`)?.classList.add('active');
      openTabOnly(id);
    }
    
    function openTabOnly(id){
      sections.forEach(s=>s.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      if(id === 'stock') renderStock();
      if(id === 'expiry') checkExpiryAlerts();
      if(id === 'purchase') renderPurchase();
      if(id === 'research') renderResearch();
    }
    // init render
    renderStock();
    renderPurchase();
    renderResearch();
  </script>
</body>
</html>